name: Release DMG (Signed)

on:
  workflow_dispatch:
    inputs:
      enable_signed_release:
        description: "Set to true to run signed/notarized release"
        required: true
        default: "false"

permissions:
  contents: write

jobs:
  build-sign-notarize:
    if: ${{ github.event.inputs.enable_signed_release == 'true' }}
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: |
          rm -rf Resourcio.xcodeproj
          xcodegen generate --spec project.yml
          grep -m1 "objectVersion" Resourcio.xcodeproj/project.pbxproj

      - name: Import signing certificate
        env:
          SIGNING_CERT_BASE64: ${{ secrets.SIGNING_CERT_BASE64 }}
          SIGNING_CERT_PASSWORD: ${{ secrets.SIGNING_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/cert.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          [[ -n "$SIGNING_CERT_BASE64" ]] || { echo "SIGNING_CERT_BASE64 is empty"; exit 1; }
          [[ -n "$SIGNING_CERT_PASSWORD" ]] || { echo "SIGNING_CERT_PASSWORD is empty"; exit 1; }
          [[ -n "$KEYCHAIN_PASSWORD" ]] || { echo "KEYCHAIN_PASSWORD is empty"; exit 1; }

          # Decode base64 in a macOS-compatible way.
          echo "$SIGNING_CERT_BASE64" | base64 -D > "$CERT_PATH"
          [[ -s "$CERT_PATH" ]] || { echo "Decoded cert file is empty"; exit 1; }

          # Validate the p12/password pair before importing into keychain.
          openssl pkcs12 -in "$CERT_PATH" -passin "pass:$SIGNING_CERT_PASSWORD" -nokeys -clcerts >/dev/null

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$SIGNING_CERT_PASSWORD" -f pkcs12 -k "$KEYCHAIN_PATH" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Prepare export options
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: sed "s/__TEAM_ID__/${APPLE_TEAM_ID}/g" config/exportOptions.plist > dist-exportOptions.plist

      - name: Archive
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild \
            -project Resourcio.xcodeproj \
            -scheme Resourcio \
            -configuration Release \
            -archivePath dist/Resourcio.xcarchive \
            archive \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            CODE_SIGN_STYLE=Automatic

      - name: Export app
        run: |
          xcodebuild \
            -exportArchive \
            -archivePath dist/Resourcio.xcarchive \
            -exportPath dist/export \
            -exportOptionsPlist dist-exportOptions.plist

      - name: Ensure runtime signature
        env:
          DEVELOPER_ID_APPLICATION: ${{ secrets.DEVELOPER_ID_APPLICATION }}
        run: |
          codesign --force --options runtime --timestamp --sign "$DEVELOPER_ID_APPLICATION" "dist/export/Resourcio.app"

      - name: Notarize app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          xcrun notarytool submit "dist/export/Resourcio.app" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --wait
          xcrun stapler staple "dist/export/Resourcio.app"

      - name: Build DMG
        run: |
          mkdir -p dist/dmg-stage
          cp -R dist/export/Resourcio.app dist/dmg-stage/
          ln -s /Applications dist/dmg-stage/Applications
          hdiutil create \
            -volname "Resourcio" \
            -srcfolder dist/dmg-stage \
            -ov \
            -format UDZO \
            dist/Resourcio.dmg

      - name: Notarize and staple DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          xcrun notarytool submit "dist/Resourcio.dmg" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --wait
          xcrun stapler staple "dist/Resourcio.dmg"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/Resourcio.dmg
